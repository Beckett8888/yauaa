#
# Yet Another UserAgent Analyzer
# Copyright (C) 2013-2018 Niels Basjes
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an AS IS BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#https://en.wikipedia.org/wiki/List_of_web_browsers
#
#Layout engines
#Gecko is developed by the Mozilla Foundation.
#KHTML is developed by the KDE project.
#Presto is developed by Opera Software for use in Opera. Development stopped as Opera transitioned to Blink.
#Tasman was developed by Microsoft for use in Internet Explorer 5 for Macintosh.
#Trident is developed by Microsoft for use in the Windows versions of Internet Explorer 4 to Internet Explorer 11.
#WebKit is a fork of KHTML by Apple Inc. used in Apple Safari, Chromium and Google Chrome.
#Blink is a 2013 fork of WebKit by Google used in Chromium, Google Chrome and Opera.[20]
#Servo is an experimental web browser layout engine being developed cooperatively by Mozilla and Samsung.
#EdgeHTML is the engine developed by Microsoft for Edge. It is a largely rewritten fork of Trident with all legacy code removed.

config:

- lookup:
    name: 'SpecialChromeBrowserNames'
    map:
      "Vivaldi"         : "Vivaldi"
      "OPR"             : "Opera"
      "MMS"             : "Opera Neon"
      "OPT"             : "Opera Touch"
      "Amigo"           : "Amigo"       # https://amigo.mail.ru/
      "MRCHROME"        : "Amigo"       # https://amigo.mail.ru/
      "MRPULSE"         : "Pulse"       # https://amigo.mail.ru/
      "Chromium"        : "Chromium"
      "Ubuntu Chromium" : "Chromium"
      "snap Chromium"   : "Chromium"
      "Epiphany"        : "Epiphany"
      "UCBrowser"       : "UCBrowser"
      "Viera"           : "Viera"
      "Puffin"          : "Puffin"
      "AvantBrowser"    : "AvantBrowser"
      "CoolNovo"        : "CoolNovo"
      "Iron"            : "Iron"
      "Quark"           : "Quark"
      "Mxbrowser"       : "Maxthon"
      "Brave Chrome"    : "Brave"
      "Iron Safari"     : "Iron"
      "Mobile Iron Safari" : "Iron"
      "Falkon"          : "Falkon"
      "QupZilla"        : "QupZilla"

- lookup:
    name: 'KnownWebviewAppNames'
    map:
      'GSApp' : 'Google Search App'
      'Focus' : 'Firefox Focus'

- matcher:
    extract:
    - 'AgentClass                          :   2014 :"Browser"'
    - 'AgentName                           :   2014 :"Chrome"'
    - 'AgentVersion                        :   2014 :agent.product.(1)name="Chrome"^.version'

  # Chrome on iOS
- matcher:
    extract:
    - 'AgentClass                          :   2014 :"Browser"'
    - 'AgentName                           :   2014 :"Chrome"'
    - 'AgentVersion                        :   2014 :agent.product.(1)name="CriOS"^.version'

  # Chrome uses Blink starting with version 28
  # See https://en.wikipedia.org/wiki/Blink_(web_engine)
  # We define the 'old' version with a higher score and set the new one as the default
- matcher:
    require:
    - 'LookUp[ChromeLayoutEngineName;agent.product.(1)name="Chrome"^.version[-1]]'
    extract:
    - 'LayoutEngineClass                   :   1000 :"Browser"'
    - 'LayoutEngineName                    :   1000 :"AppleWebKit"'
    - 'LayoutEngineVersion                 :   1000 :agent.product.(1)name="AppleWebKit"^.version'

- matcher:
    extract:
    - 'LayoutEngineClass                   :    999 :"Browser"'
    - 'LayoutEngineName                    :    999 :"Blink"'
    - 'LayoutEngineVersion                 :    999 :agent.product.(1)name="Chrome"^.version[-2]'

- matcher:
    require:
    - 'LookUp[ChromeLayoutEngineName;agent.product.(1)name="CriOS"^.version[-1]]'
    extract:
    - 'LayoutEngineClass                   :   1000 :"Browser"'
    - 'LayoutEngineName                    :   1000 :"AppleWebKit"'
    - 'LayoutEngineVersion                 :   1000 :agent.product.(1)name="AppleWebKit"^.version'

- matcher:
    extract:
    - 'LayoutEngineClass                   :    999 :"Browser"'
    - 'LayoutEngineName                    :    999 :"Blink"'
    - 'LayoutEngineVersion                 :    999 :agent.product.(1)name="CriOS"^.version[-2]'

# Sometimes (Coc coc does this) we do not have "Chrome" with "Mobile Safari" but instead: "Mobile Chrome" with "Safari"
- matcher:
    require:
    - 'LookUp[ChromeLayoutEngineName;agent.product.(1)name="Mobile Chrome"^.version[-1]]'
    extract:
    - 'DeviceClass                         :   1000 :"Phone"'
    - 'LayoutEngineClass                   :   1000 :"Browser"'
    - 'LayoutEngineName                    :   1000 :"AppleWebKit"'
    - 'LayoutEngineVersion                 :   1000 :agent.product.(1)name="AppleWebKit"^.version'

- matcher:
    extract:
    - 'DeviceClass                         :    999 :"Phone"'
    - 'LayoutEngineClass                   :    999 :"Browser"'
    - 'LayoutEngineName                    :    999 :"Blink"'
    - 'LayoutEngineVersion                 :    999 :agent.product.(1)name="Mobile Chrome"^.version[-2]'


- lookup:
    name: 'ChromeLayoutEngineName'
    map:
      "0"  : "AppleWebKit"
      "1"  : "AppleWebKit"
      "2"  : "AppleWebKit"
      "3"  : "AppleWebKit"
      "4"  : "AppleWebKit"
      "5"  : "AppleWebKit"
      "6"  : "AppleWebKit"
      "7"  : "AppleWebKit"
      "8"  : "AppleWebKit"
      "9"  : "AppleWebKit"
      "10" : "AppleWebKit"
      "11" : "AppleWebKit"
      "12" : "AppleWebKit"
      "13" : "AppleWebKit"
      "14" : "AppleWebKit"
      "15" : "AppleWebKit"
      "16" : "AppleWebKit"
      "17" : "AppleWebKit"
      "18" : "AppleWebKit"
      "19" : "AppleWebKit"
      "20" : "AppleWebKit"
      "21" : "AppleWebKit"
      "22" : "AppleWebKit"
      "23" : "AppleWebKit"
      "24" : "AppleWebKit"
      "25" : "AppleWebKit"
      "26" : "AppleWebKit"
      "27" : "AppleWebKit"


# Webview
# https://developer.chrome.com/multidevice/user-agent

# WebView UA in KitKat to Lollipop
# Mozilla/5.0 (Linux; Android 4.4; Nexus 5 Build/_BuildID_) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/30.0.0.0 Mobile Safari/537.36
# If you’re attempting to differentiate between the WebView and Chrome for Android, you should look for the
# presence of the Version/_X.X_ string in the WebView user-agent string.
# Don’t rely on the specific Chrome version number (for example, 30.0.0.0) as the version numbers
# changes with each release.

- matcher:
    require:
    - 'agent.product.(1)name="Version"'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :      0 :"Unknown Webview App"'
    - 'WebviewAppVersion                   :      0 :"??"'

- matcher:
    require:
    - 'agent.product.(1)name="Version"'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     10 :NormalizeBrand[agent.product.(1)name="Chrome"^>>.name]'
    - 'WebviewAppVersion                   :     10 :agent.product.(1)name="Chrome"^>>.version'

- matcher:
    variable:
    - 'WebViewProduct: agent.product.(1)name="Chrome"^>>'
    require:
    - 'agent.product.(1)name="Version"'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     11 :LookUp[SpecialChromeBrowserNames;@WebViewProduct.name]'
    - 'WebviewAppVersion                   :     11 :@WebViewProduct.version'

- matcher:
    require:
    - 'agent.product.(1)name="Version"'
    - 'agent.product.(1)name="Chrome"'
    variable:
    - 'WebViewProduct: agent.product.(1)name="Version"^>>.name="Chrome"^<'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     12 :LookUp[SpecialChromeBrowserNames;@WebViewProduct.name]'
    - 'WebviewAppVersion                   :     12 :@WebViewProduct.version'


- matcher:
    require:
    - 'agent.product.(1)name="Version"'
    - 'agent.product.(1)name="Chrome"'
    - 'agent.product.(1)name="Safari"'
    variable:
    - 'WebViewProduct: agent.product.(1)name="Version"^>.name="Chrome"^>>.name="Safari"^<'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     12 :LookUp[SpecialChromeBrowserNames;@WebViewProduct.name]'
    - 'WebviewAppVersion                   :     12 :@WebViewProduct.version'

- matcher:
    require:
    - 'agent.product.(1)name="Version"'
    - 'agent.product.(1)name="Chrome"'
    - 'agent.product.(1)name="Mobile Safari"'
    variable:
    - 'WebViewProduct: agent.product.(1)name="Version"^>.name="Chrome"^>>.name="Mobile Safari"^<'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     12 :LookUp[SpecialChromeBrowserNames;@WebViewProduct.name]'
    - 'WebviewAppVersion                   :     12 :@WebViewProduct.version'

- matcher:
    variable:
    - 'WebViewProduct: agent.product.(1)name="Chrome"^>>'
    require:
    - 'agent.product.(1)name="Version"'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     11 :LookUp[KnownWebviewAppNames;@WebViewProduct.name]'
    - 'WebviewAppVersion                   :     11 :@WebViewProduct.version'

- matcher:
    variable:
    - 'WebViewProduct: agent.product.(1)name="Version"^>>.name="Chrome"^<'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     12 :LookUp[KnownWebviewAppNames;@WebViewProduct.name]'
    - 'WebviewAppVersion                   :     12 :@WebViewProduct.version'

- matcher:
    variable:
    - 'WebViewProduct: agent.product.(1)name="Version"^>>.name="Chrome"^<'
    extract:
    - 'AgentClass                          :   2500 :"Browser Webview"'
    - 'AgentName                           :   2500 :"Chrome Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :     11 :@WebViewProduct.name'
    - 'WebviewAppVersion                   :     11 :@WebViewProduct.version'

# WebView UA in Lollipop and Above
# In the newer versions of WebView, you can differentiate the WebView by looking for the wv field
# as highlighted below.

# Mozilla/5.0 (Linux; Android 5.1.1; Nexus 5 Build/LMY48B; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/43.0.2357.65 Mobile Safari/537.36

- matcher:
    require:
    - 'agent.(1)product.(1)comments.entry.(1)text="wv"'
    extract:
    - 'AgentClass                          :  10000 :"Browser Webview"'
    - 'AgentName                           :  10000 :"Chrome Webview"'
    - 'AgentVersion                        :  10000 :agent.product.(1)name="Chrome"^.version'
    - 'WebviewAppName                      :      0 :"Unknown Webview App"'
    - 'WebviewAppVersion                   :      0 :"??"'

- matcher:
    variable:
    - 'ProductAfterChrome: agent.product.(1)name="Chrome"^>'
    extract:
    - 'AgentName                           :   2022 :LookUp[SpecialChromeBrowserNames;@ProductAfterChrome.(1)name]'
    - 'AgentVersion                        :   2022 :@ProductAfterChrome.(1)version'

- matcher:
    variable:
    - 'ProductAfterChrome: agent.product.(1)name="Chrome"^>>'
    extract:
    - 'AgentName                           :   2021 :LookUp[SpecialChromeBrowserNames;@ProductAfterChrome.(1)name]'
    - 'AgentVersion                        :   2021 :@ProductAfterChrome.(1)version'

- matcher:
    variable:
    - 'ProductAfterChrome: agent.product.(1)name="Chrome"^>>>'
    extract:
    - 'AgentName                           :   2020 :LookUp[SpecialChromeBrowserNames;@ProductAfterChrome.(1)name]'
    - 'AgentVersion                        :   2020 :@ProductAfterChrome.(1)version'

- matcher:
    variable:
    - 'ProductAfterChrome: agent.product.(1)name="Chrome"^>>>>'
    extract:
    - 'AgentName                           :   2019 :LookUp[SpecialChromeBrowserNames;@ProductAfterChrome.(1)name]'
    - 'AgentVersion                        :   2019 :@ProductAfterChrome.(1)version'

- matcher:
    extract:
    - 'AgentName                           :   2019 :LookUp[SpecialChromeBrowserNames;agent.text]'
    - 'AgentVersion                        :   2019 :agent.product.(1)name="Chrome"^.version'

- matcher:
    variable:
    - 'ProductBeforeChrome: agent.product.(1)name="Chrome"^<'
    extract:
    - 'AgentName                           :   2017 :LookUp[SpecialChromeBrowserNames;@ProductBeforeChrome.(1)name]'
    - 'AgentVersion                        :   2017 :@ProductBeforeChrome.(1)version'


- matcher:
    variable:
    - 'ChromeName:agent.product.(1)name[1]="Chrome"'
    - 'SafariName:agent.product.(1)name="Iron Safari"'
    - 'ProductName:@SafariName@[1]'
    require:
    - 'IsNull[agent.product.(1)name="Mobile Safari"]'
    extract:
    - 'AgentName                           :   2100 :@ProductName'
    - 'AgentVersion                        :   2100 :@ChromeName^.version'

- matcher:
    variable:
    - 'ChromeName:agent.product.(1)name[1]="Chrome"'
    - 'SafariName:agent.product.(1)name[3]="Safari"'
    - 'ProductName:@SafariName@[2]'
    require:
    - 'agent.product.(1)name[1]="Mobile"' # Speedup trick
    - '@SafariName@[1]="Mobile"'
    - 'IsNull[agent.product.(1)name="Mobile Safari"]'
    - 'IsNull[agent.product.(1)name="Mobile VR Safari"]'
    extract:
    - 'AgentName                           :   2100 :@ProductName'
    - 'AgentVersion                        :   2100 :@ChromeName^.version'

