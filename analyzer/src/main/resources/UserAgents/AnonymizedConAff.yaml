#
# Yet Another UserAgent Analyzer
# Copyright (C) 2013-2019 Niels Basjes
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an AS IS BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

isConAffWindows: &isConAffWindows
    DeviceClass                           : 'Desktop'
    DeviceName                            : 'Desktop'
    DeviceBrand                           : 'Unknown'
    DeviceCpu                             : 'x64'
    DeviceCpuBits                         : '64'
    OperatingSystemClass                  : 'Desktop'
    OperatingSystemName                   : 'Windows NT'
    OperatingSystemVersion                : '10.0'
    OperatingSystemVersionMajor           : '10'
    OperatingSystemNameVersion            : 'Windows 10.0'
    OperatingSystemNameVersionMajor       : 'Windows 10'
    LayoutEngineClass                     : 'Browser'
    LayoutEngineName                      : 'Gecko'
    LayoutEngineVersion                   : '??'
    LayoutEngineVersionMajor              : '??'
    LayoutEngineNameVersion               : 'Gecko ??'
    LayoutEngineNameVersionMajor          : 'Gecko ??'
    LayoutEngineBuild                     : '20100101'
    AgentClass                            : 'Browser'
    AgentName                             : 'Firefox'
    AgentVersion                          : '??'
    AgentVersionMajor                     : '??'
    AgentNameVersion                      : 'Firefox ??'
    AgentNameVersionMajor                 : 'Firefox ??'
    WebviewAppVersionMajor                : '??'
    WebviewAppNameVersionMajor            : 'Unknown'
    Anonymized                            : 'Anonymized con_aff'

isConAffMacChrome: &isConAffMacChrome
    DeviceClass                          : 'Desktop'
    DeviceName                           : 'Apple Macintosh'
    DeviceBrand                          : 'Apple'
    DeviceCpu                            : 'Intel'
    OperatingSystemClass                 : 'Desktop'
    OperatingSystemName                  : 'Mac OS X'
    OperatingSystemVersion               : '10.??'
    OperatingSystemVersionMajor          : '10'
    OperatingSystemNameVersion           : 'Mac OS X 10.??'
    OperatingSystemNameVersionMajor      : 'Mac OS X 10'
    LayoutEngineClass                    : 'Browser'
    LayoutEngineName                     : 'Blink'
    LayoutEngineVersion                  : '68.??'
    LayoutEngineVersionMajor             : '68'
    LayoutEngineNameVersion              : 'Blink 68.??'
    LayoutEngineNameVersionMajor         : 'Blink 68'
    AgentClass                           : 'Browser'
    AgentName                            : 'Chrome'
    AgentVersion                         : '68.??'
    AgentVersionMajor                    : '68'
    AgentNameVersion                     : 'Chrome 68.??'
    AgentNameVersionMajor                : 'Chrome 68'
    Anonymized                           : 'Anonymized con_aff'


config:

# con_aff/ seems to be an Anonimyzer that scrambles several values
# ~ 3000 useragents on a single day with a single visitor
# cat con_aff.txt | sed 's@  \+[0-9]\+ @@'  | sed 's@Mozilla/[0-9]\.[0-9] @Mozilla/9.9 @g;s@10_[0-9]\+_[0-9]@10_9_9@g;s@x64 [0-9][0-9]\.[0-9]\+@x64 99.9@g;s@rv:[0-9][0-9]\.[0-9]@rv:99.9@g;s@Firefox/[0-9]\+\.[0-9]@Firefox/99.9@g;s@Gecko/2010010[0-9]@Gecko/20100101@g;s@Chrome/68\.0\.[0-9][0-9][0-9][0-9]\.1[0-9][0-9]@Chrome/68.0.9999.199@g;s@Safari/[0-9][0-9]7\.[0-9][0-9]@Safari/997.99@g' | sort -u

- matcher:
    require:
    - 'agent.product.name="con_aff"'
    extract:
    - 'Anonymized                          : 100200 :"Anonymized con_aff"'
    - 'OperatingSystemVersion              : 100200 :Concat[agent.product.comments.entry.product.name="Intel Mac OS X"^.version[1];".??"]'

- matcher:
    require:
    - 'agent.product.name="con_aff"'
    variable:
    - 'ChromeVersion: Concat[agent.product.name="Chrome"^.version[1];".??"]'
    extract:
    - 'Anonymized                          : 100200 :"Anonymized con_aff"'
    - 'LayoutEngineVersion                 : 100200 :@ChromeVersion'
    - 'AgentVersion                        : 100200 :@ChromeVersion'

- matcher:
    require:
    - 'agent.product.name="con_aff"'
    - 'agent.product.name="Firefox"'
    extract:
    - 'Anonymized                          : 100200 :"Anonymized con_aff"'
    - 'LayoutEngineVersion                 : 100200 :"??"'
    - 'LayoutEngineBuild                   : 100200 :"20100101"'
    - 'AgentVersion                        : 100200 :"??"'

- test:
    input: # Simplified by aggregating the examples available
      user_agent_string: 'Mozilla/9.9 (Macintosh; Intel Mac OS X 10_9_9) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.9999.199 Safari/997.99 con_aff/'
    expected: *isConAffMacChrome

- test:
    input:
      user_agent_string: 'Mozilla/6.5 (Macintosh; Intel Mac OS X 10_13_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.3535.135 Safari/667.35 con_aff/'
    expected: *isConAffMacChrome

- test:
    input:
      user_agent_string: 'Mozilla/6.7 (Macintosh; Intel Mac OS X 10_10_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.5353.153 Safari/667.53 con_aff/'
    expected: *isConAffMacChrome

- test:
    input:
      user_agent_string: 'Mozilla/6.8 (Macintosh; Intel Mac OS X 10_13_8) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/68.0.2626.126 Safari/667.26 con_aff/'
    expected: *isConAffMacChrome


- test:
    input:
      user_agent_string: 'Mozilla/9.9 (Windows NT 10.0; Win64; x64 99.9; rv:99.9) Gecko/20100101 Firefox/99.9 con_aff/'
    expected: *isConAffWindows

- test:
    input:
      user_agent_string: 'Mozilla/6.7 (Windows NT 10.0; Win64; x64 17.1; rv:38.1) Gecko/20100101 Firefox/38.1 con_aff/'
    expected: *isConAffWindows
- test:
    input:
      user_agent_string: 'Mozilla/6.3 (Windows NT 10.0; Win64; x64 17.12; rv:39.9) Gecko/20100109 Firefox/39.9 con_aff/'
    expected: *isConAffWindows

