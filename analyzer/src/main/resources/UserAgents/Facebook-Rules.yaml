#
# Yet Another UserAgent Analyzer
# Copyright (C) 2013-2018 Niels Basjes
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an AS IS BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# Apparently the Facebook apps send out extra fields in the useragent string telling a lot about the device.
# See also
# http://mpulp.mobi/2012/01/funky-user-agent-on-facebook-iphone-app/
# http://stackoverflow.com/questions/11414006/is-this-a-facebook-for-ios-webview-user-agent
# http://stackoverflow.com/questions/29094232/what-is-the-user-agent-string-for-facebook-app-from-android
config:

#========================================

- lookup:
    name: 'FaceBookAppNames'
    map:
        'FBW'              : 'Facebook for Windows'
        'FB4A'             : 'Facebook App for Android'
        'FBIOS'            : 'Facebook App for iOS'
        'FBForIPhone'      : 'Facebook App for iOS'
        'MessengerForiOS'  : 'Facebook Messenger for iOS'
        'FBMentionsForiOS' : 'Facebook Mentions for iOS' # Special app for actors and such
        'FBPageAdmin'      : 'Facebook Pageadmin'
        'GroupsForiOS'     : 'Facebook Groups for iOS'
        'AtWorkForiOS'     : 'Facebook at Work for iOS'
        'FBBlack'          : 'FBBlack'                   # Unknown, perhaps hacked useragent string?

- lookup:
    name: 'FaceBookWebviewNames'
    map:
        'FBW'              : 'Chrome WebView'
        'FB4A'             : 'Chrome Webview'
        'FBIOS'            : 'UIWebView'
        'FBForIPhone'      : 'UIWebView'
        'MessengerForiOS'  : 'UIWebView'
        'GroupsForiOS'     : 'UIWebView'
        'AtWorkForiOS'     : 'UIWebView'

- matcher:
    variable:
    - 'FBANVersion       : agent.product.(1-2)comments.entry.(1)product.(1)name="FBAN"^.version'
    extract:
    - 'AgentClass                          :   1001 :"Browser Webview"'
    - 'AgentName                           :   1001 :LookUp[FaceBookWebviewNames;@FBANVersion]'
    - 'AgentVersion                        :     11 :"??"'
    - 'WebviewAppName                      :   1001 :LookUp[FaceBookAppNames;@FBANVersion]'
    - 'WebviewAppVersion                   :   1001 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAV"^.version'

- matcher:
    extract:
    - 'AgentClass                          :   1000 :"Mobile App"'
    - 'AgentName                           :   1000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAN"^.version'
    - 'AgentVersion                        :      5 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAV"^.version'
    - 'WebviewAppName                      :   1000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAN"^.version'
    - 'WebviewAppVersion                   :   1000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAV"^.version'

- matcher:
    extract:
    - 'AgentClass                          :   1001 :"Browser Webview"'
    - 'AgentName                           :   1001 :LookUp[FaceBookWebviewNames;agent.product.(1-2)comments.entry.(1)product.(1)name="FB_IAB"^.version]'
    - 'AgentVersion                        :   1001 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAV"^.version'
    - 'WebviewAppName                      :   1001 :LookUp[FaceBookAppNames;agent.product.(1-2)comments.entry.(1)product.(1)name="FB_IAB"^.version]'
    - 'WebviewAppVersion                   :   1001 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAV"^.version'

- matcher:
    extract:
    - 'AgentClass                          :   1000 :"Mobile App"'
    - 'AgentName                           :   1000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FB_IAB"^.version'
    - 'AgentVersion                        :      5 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAV"^.version'
    - 'WebviewAppName                      :   1000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FB_IAB"^.version'
    - 'WebviewAppVersion                   :   1000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBAV"^.version'

- matcher:
    require:
    - 'agent.product.(1-2)comments.entry.(1)product.(1)name="FBAN"'
    extract:
    - 'AgentBuild                          :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBBV"^.version'

- matcher:
    require:
    - 'agent.product.(1-2)comments.entry.(1)product.(1)name="FB_IAB"'
    extract:
    - 'AgentBuild                          :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBBV"^.version'

#========================================

- matcher:
    extract:
    - 'FacebookDeviceClass                 :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBID"^.version'
    - 'FacebookDeviceName                  :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBMD"^.version'
    - 'FacebookDeviceVersion               :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBDV"^.version'

- matcher:
    require:
    - 'agent.product.(1-2)comments.entry.(1)product="FBID/desktop"'
    extract:
    - 'DeviceClass                         :    200 :"Desktop"'

- matcher:
    require:
    - 'agent.product.(1-2)comments.entry.(1)product="FBID/tablet"'
    extract:
    - 'DeviceClass                         :    200 :"Tablet"'

- matcher:
    require:
    - 'agent.product.(1-2)comments.entry.(1)product="FBID/phone"'
    extract:
    - 'DeviceClass                         :    200 :"Phone"'

- matcher:
    extract:
    - 'DeviceName                          :    200 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBMD"^.version'
    - 'DeviceVersion                       :    200 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBDV"^.version'

- matcher:
    extract:
    - 'DeviceClass                         :    198 :LookUp[AppleDeviceClass;agent.product.(1-2)comments.entry.(1)product.(1)name="FBMD"^.version]'
    - 'DeviceName                          :    201 :LookUp[AppleDeviceName;agent.product.(1-2)comments.entry.(1)product.(1)name="FBMD"^.version]'
    - 'DeviceVersion                       :    201 :LookUp[AppleDeviceVersion;agent.product.(1-2)comments.entry.(1)product.(1)name="FBDV"^.version]'
    - 'DeviceBrand                         :    201 :"Apple"'

- matcher:
    extract:
    - 'FacebookOperatingSystemName         :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBSN"^.version'
    - 'FacebookOperatingSystemVersion      :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBSV"^.version'
    - 'FacebookFBSS                        :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBSS"^.version'

- matcher:
    extract:
    - 'OperatingSystemClass                :      9 :"Mobile"'
    - 'OperatingSystemName                 :    199 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBSN"^.version'
    - 'OperatingSystemVersion              :    199 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBSV"^.version'

- lookup:
    name: 'OSNameCleanup'
    map:
      "iPhone"     : "iOS"
      "iPhone OS"  : "iOS"
      "iPhoneOS"   : "iOS"
      "iPad"       : "iOS"
      "iPad OS"    : "iOS"
      "iPadOS"     : "iOS"
      "iPod"       : "iOS"
      "iPod OS"    : "iOS"
      "iPodOS"     : "iOS"

- matcher:
    extract:
    - 'OperatingSystemClass                :     10 :"Mobile"'
    - 'OperatingSystemName                 :    200 :LookUp[OSNameCleanup;agent.product.(1-2)comments.entry.(1)product.(1)name="FBSN"^.version]'
    - 'OperatingSystemVersion              :    200 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBSV"^.version'

- matcher:
    extract:
    - 'AgentLanguage                       :   3001 :LookUp[ISOLanguageCodesName;agent.product.(1-2)comments.entry.(1)product.(1)name="FBLC"^.version]'
    - 'AgentLanguageCode                   :   3001 :LookUp[ISOLanguageCodes;agent.product.(1-2)comments.entry.(1)product.(1)name="FBLC"^.version]'

- matcher:
    extract:
    - 'AgentLanguage                       :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBLC"^.version'
    - 'AgentLanguageCode                   :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBLC"^.version'

- matcher:
    extract:
    - 'FacebookCarrier                     :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBCR"^.version'
    - 'Carrier                             :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBCR"^.version'

- matcher:
    extract:
    - 'FacebookFBOP                        :   3000 :agent.product.(1-2)comments.entry.(1)product.(1)name="FBOP"^.version'

