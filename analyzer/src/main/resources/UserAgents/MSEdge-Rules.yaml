#
# Yet Another UserAgent Analyzer
# Copyright (C) 2013-2018 Niels Basjes
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an AS IS BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

# https://msdn.microsoft.com/en-us/library/ms537503(v=vs.85).aspx

config:

# https://msdn.microsoft.com/en-us/library/hh869301(v=vs.85).aspx
# User-agent strings for Microsoft Edge

# Desktop
# Mozilla/5.0 (Windows NT 10.0; <64-bit tags>) AppleWebKit/<WebKit Rev> (KHTML, like Gecko) Chrome/<Chrome Rev> Safari/<WebKit Rev> Edge/<EdgeHTML Rev>.<Windows Build>

# Mobile:
# Mozilla/5.0 (Windows Phone 10.0; Android <Android Version>; <Device Manufacturer>; <Device Model>) AppleWebKit/<WebKit Rev> (KHTML, like Gecko) Chrome/<Chrome Rev> Mobile Safari/<WebKit Rev> Edge/<EdgeHTML Rev>.<Windows Build>

# Webview
# Note  "MSAppHost/<WebView Rev>" is added when EdgeHTML is hosted in a Universal Windows App using WebView.


# As clearly visible Microsoft does not include the version of the application in the useragent.
# So if we have the EdgeHTML version and the OS build in this table then we have the version of Edge.
# NOTE: Yes, MS deployed the browser as an OS update ... <face palm> ...

# 2018-12-12 Copied from https://en.wikipedia.org/wiki/Microsoft_Edge
- lookup:
    name: 'EdgeHtmlVersionToEdgeVersion'
    map:
      "12.10049" : "0.10.10049"
      "12.10051" : "0.11.10051"
      "12.10052" : "0.11.10052"
      "12.10061" : "0.11.10061"
      "12.10074" : "0.11.10074"
      "12.10080" : "0.11.10080"
      "12.10122" : "13.10122"
      "12.10130" : "15.10130"
      "12.10136" : "16.10136"
      "12.10149" : "19.10149"
      "12.10158" : "20.10158"
      "12.10159" : "20.10159"
      "12.10162" : "20.10162"
      "12.10166" : "20.10166"
      "12.10240" : "20.10240"
      "12.10525" : "20.10525"
      "12.10532" : "20.10532"
      "12.10536" : "20.10536"
      "13.10547" : "21.10547"
      "13.10549" : "21.10549"
      "13.10553" : "22.10553" # Apparently an Xbox specific version. The 22 is an educated guess.
      "13.10565" : "23.10565"
      "13.10572" : "25.10572"
      "13.10576" : "25.10576"
      "13.10581" : "25.10581"
      "13.10586" : "25.10586"
      "13.11082" : "25.11082"
      "13.11099" : "27.11099"
      "13.11102" : "28.11102"
      "13.14251" : "28.14251"
      "13.14257" : "28.14257"
      "14.14267" : "31.14267"
      "14.14271" : "31.14271"
      "14.14279" : "31.14279"
      "14.14283" : "31.14283"
      "14.14291" : "34.14291"
      "14.14295" : "34.14295"
      "14.14300" : "34.14300"
      "14.14316" : "37.14316"
      "14.14322" : "37.14322"
      "14.14327" : "37.14327"
      "14.14328" : "37.14328"
      "14.14332" : "37.14332"
      "14.14342" : "38.14342"
      "14.14352" : "38.14352"
      "14.14393" : "38.14393"
      "14.14901" : "39.14901"
      "14.14905" : "39.14905"
      "14.14915" : "39.14915"
      "14.14926" : "39.14926"
      "14.14931" : "39.14931"
      "14.14936" : "39.14936"
      "15.14942" : "39.14942"
      "15.14946" : "39.14946"
      "15.14951" : "39.14951"
      "15.14955" : "39.14955"
      "15.14959" : "39.14959"
      "15.14965" : "39.14965"
      "15.14971" : "39.14971"
      "15.14977" : "39.14977"
      "15.14986" : "39.14986"
      "15.15063" : "40.15063"
      "16.16299" : "41.16299.15"
      "17.17134" : "42.17134"
      "18.17763" : "44.17763"
      # In addition if the Windows 10 build is not in this list we assume the base version is using the latest major
      "12"       : "20.??"
      "13"       : "28.??"
      "14"       : "39.??"
      "15"       : "40.??"
      "16"       : "41.??"
      "17"       : "42.??"
      "18"       : "44.??"


- matcher:
    variable:
    - 'EdgeHtmlVersion                     : agent.product.name="Edge"^.version'
    - 'EdgeHtmlVersionFirstWord            : @EdgeHtmlVersion[-1]'
    extract:
    - 'LayoutEngineClass                   :   2015 :"Browser"'
    - 'LayoutEngineName                    :   2015 :"EdgeHTML"'
    - 'LayoutEngineVersion                 :   2015 :@EdgeHtmlVersionFirstWord'

    - 'AgentClass                          :   2016 :"Browser"'
    - 'AgentName                           :   2016 :"Edge"'
    - 'AgentVersion                        :   2016 :LookUp[EdgeHtmlVersionToEdgeVersion;@EdgeHtmlVersionFirstWord;"??"]'

- matcher:
    variable:
    - 'EdgeHtmlVersion                     : agent.product.name="Edge"^.version'
    - 'EdgeHtmlVersionFirstWord            : @EdgeHtmlVersion[-1]'
    extract:
    - 'LayoutEngineClass                   :   2015 :"Browser"'
    - 'LayoutEngineName                    :   2015 :"EdgeHTML"'
    - 'LayoutEngineVersion                 :   2015 :@EdgeHtmlVersionFirstWord'

    - 'AgentClass                          :   2017 :"Browser"'
    - 'AgentName                           :   2017 :"Edge"'
    - 'AgentVersion                        :   2017 :LookUp[EdgeHtmlVersionToEdgeVersion;@EdgeHtmlVersion]'

# If it is not '??' then the second part of the Edge version is the Windows 10 BUILD number
- matcher:
    require:
    - 'agent.product.name="Edge"^.version[2]!="0"'
    extract:
    - 'OperatingSystemVersionBuild         :    100 :agent.product.name="Edge"^.version[2]'


# Edge (IE >= 12):

# Deliberate error: An Edge version tag where the OS build is not in the lookup
# Deliberate error: An Edge version tag where the major version is not in the lookup
# =================================================
# Edge for Android & iOS
# Specs:
# https://blogs.windows.com/msedgedev/2017/10/05/microsoft-edge-ios-android-developer/
# A few notes:
# - The app/OS identifier is chosen so that it does not contain the string “Edge.”
#   This is to avoid triggering any existing UA detection logic that might accidentally decide that
#   these browsers are Microsoft Edge for Windows 10, resulting in a desktop site or something equally confusing.
# - The version number “41” is the app version number aligned across all current versions of Microsoft Edge
#   (note that for simplicity, the app version number is not currently exposed in Microsoft Edge for PC;
#   only the EdgeHTML engine version number is exposed).
# - The sub-version number is a platform-specific version number that internal version number of
#   the app on that platform.

# Specs say:
# On Android, we are using the Blink rendering engine from the Chromium browser project.
# This approach gives us more control and better performance than using the Android WebView control,
# but means that we are shipping our own copy of the rendering engine in the app.
- matcher:
    extract:
    - 'LayoutEngineClass                   :   2015 :"Browser"'
    - 'LayoutEngineName                    :   2015 :"Blink"'
    - 'LayoutEngineVersion                 :   2015 :agent.product.name="Chrome"^.version[-2]'

    - 'AgentClass                          :   2015 :"Browser"'
    - 'AgentName                           :   2015 :"Edge"'
    - 'AgentVersion                        :   2015 :agent.product.name="EdgA"^.version'

# Specs say:
# On iOS, we are using the WebKit engine, as provided by iOS in the WKWebView control.
# That means that from a compatibility perspective, Microsoft Edge for iOS should match
# the version of Safari that is currently available for iOS.
- matcher:
    extract:
    - 'LayoutEngineClass                   :   2015 :"Browser"'
    - 'LayoutEngineName                    :   2015 :"AppleWebKit"'
    - 'LayoutEngineVersion                 :   2015 :agent.product.name="AppleWebKit"^.version'

    - 'AgentClass                          :   2050 :"Browser"'
    - 'AgentName                           :   2050 :"Edge"'
    - 'AgentVersion                        :   2050 :agent.product.name="EdgiOS"^.version'

# ===============================================

# MSAppHost means webview

- matcher:
    require:
    - 'agent.product.(1)name="Edge"'
    extract:
    - 'AgentClass                          :  10000 :"Browser Webview"'
    - 'AgentName                           :  10000 :"Edge Webview"'
    - 'AgentVersion                        :   2500 :agent.(1)product.(1)comments.entry.product.name="MSAppHost"^.version'
    - 'WebviewAppName                      :      0 :"Unknown Webview App"'
    - 'WebviewAppVersion                   :      0 :"??"'

- matcher:
    require:
    - 'agent.product.(1)name="Edge"'
    extract:
    - 'AgentClass                          :  10000 :"Browser Webview"'
    - 'AgentName                           :  10000 :"Edge Webview"'
    - 'AgentVersion                        :   2500 :agent.product.(1)name="MSAppHost"^.version'
    - 'WebviewAppName                      :      0 :"Unknown Webview App"'
    - 'WebviewAppVersion                   :      0 :"??"'


