#
# Yet Another UserAgent Analyzer
# Copyright (C) 2013-2018 Niels Basjes
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an AS IS BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
config:

- matcher:
    extract:
    - 'DeviceClass                         :     50 :"Mobile"'
    - 'DeviceName                          :     10 :"Android Mobile"'
    - 'OperatingSystemClass                :    500 :"Mobile"'
    - 'OperatingSystemName                 :    500 :"Android"'
    - 'OperatingSystemVersion              :    500 :agent.(1-2)product.comments.entry.product.name[1]="Android"^.version'

- matcher:
    extract:
    - 'DeviceClass                         :     50 :"Mobile"'
    - 'DeviceName                          :     10 :"Android Mobile"'
    - 'OperatingSystemClass                :    500 :"Mobile"'
    - 'OperatingSystemName                 :    500 :"Android"'
    - 'OperatingSystemVersion              :    500 :agent.(1-2)product.comments.entry.product.name="Adr"^.version'

- matcher:
    extract:
    - 'DeviceClass                         :     51 :"Mobile"'
    - 'DeviceName                          :     11 :"Android Mobile"'
    - 'OperatingSystemClass                :    501 :"Mobile"'
    - 'OperatingSystemName                 :    501 :"Android"'
    - 'OperatingSystemVersion              :    501 :agent.product.name="Android"^.version'

- matcher:
    extract:
    - 'DeviceClass                         :     51 :"Mobile"'
    - 'DeviceName                          :     11 :"Android Mobile"'
    - 'OperatingSystemClass                :    501 :"Mobile"'
    - 'OperatingSystemName                 :    501 :"Android"'
    - 'OperatingSystemVersion              :    501 :agent.product.name="Adr"^.version'

- matcher:
    require:
    - 'agent.(1-2)product.comments.entry.text="Android"'
    extract:
    - 'DeviceClass                         :      2 :"Mobile"'
    - 'DeviceName                          :      4 :"Android Mobile"'
    - 'OperatingSystemClass                :      4 :"Mobile"'
    - 'OperatingSystemName                 :      4 :"Android"'
    - 'OperatingSystemVersion              :      4 :"??"'

- matcher:
    variable:
    - 'ProductBuild: agent.(1-2)product.(1)comments.entry.product.name="Build"^'
    require:
    - 'agent.(1-2)product.comments.entry.product.name[1]="Android"'
    extract:
    - 'DeviceClass                         :     51 :"Mobile"'
    - 'DeviceName                          :     51 :@ProductBuild<'
    - 'OperatingSystemVersionBuild         :     51 :@ProductBuild.version'

# ===========================
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Gecko_user_agent_string_reference
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent/Firefox
# https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent
# When Firefox runs on a device that has the phone form factor, there is a Mobile; token in the platform part of the UA string.
# When Firefox runs on a tablet device, there is a Tablet; token in the platform part of the UA string instead
- matcher:
    require:
    - 'agent.(1)product.comments.entry.text="Tablet"'
    extract:
    - 'DeviceClass                         :   1000 :"Tablet"'
    - 'OperatingSystemClass                :   1000 :"Mobile"'

- matcher:
    require:
    - 'agent.(1)product.comments.entry.text="Mobile"'
    extract:
    - 'DeviceClass                         :   1000 :"Phone"'
    - 'OperatingSystemClass                :   1000 :"Mobile"'

- matcher:
    require:
    - 'agent.(1)product.comments.entry.text="Phone"'
    extract:
    - 'DeviceClass                         :   1000 :"Phone"'
    - 'OperatingSystemClass                :   1000 :"Mobile"'

- matcher:
    require:
    - 'agent.(1)product.comments.entry.text="TV"'
    extract:
    - 'DeviceClass                         :   1000 :"TV"'

# ===========================
# https://developer.chrome.com/multidevice/user-agent
#   If you are parsing user agent strings using regular expressions, the following can be used to check against Chrome on Android phones and tablets:
#
#   Phone pattern: 'Android' + 'Chrome/[.0-9]* Mobile'
#   Tablet pattern: 'Android' + 'Chrome/[.0-9]* (?!Mobile)'

# We ignore the Chrome part and apply this to all "Safari/ Mobile Safari" situations on what seems to be Android

- matcher:
    require:
    - 'agent.product.(1)name="Mobile Safari"'
    extract:
    - 'DeviceClass                         :   1000 :"Phone"'
    - 'OperatingSystemClass                :   1000 :"Mobile"'

- matcher:
    require:
    - 'agent.product.(1)name[1]="Chrome"'
    - 'agent.product.(1)name[1]="Mobile"'
    extract:
    - 'DeviceClass                         :    100 :"Phone"'
    - 'OperatingSystemClass                :    100 :"Mobile"'

- matcher:
    require:
    - 'agent.(1-2)product.(1)comments.entry.(1)product.(1)name[1]="Android"'
    - 'agent.product.(1)name="Safari"'
    extract:
    - 'DeviceClass                         :   1000 :"Tablet"'
    - 'OperatingSystemClass                :   1000 :"Mobile"'

- matcher:
    require:
    - 'agent.product.(1)name[1]="Android"'
    - 'agent.product.(1)name="Safari"'
    extract:
    - 'DeviceClass                         :   1000 :"Tablet"'
    - 'OperatingSystemClass                :   1000 :"Mobile"'

# ===========================

- matcher:
    variable:
    - 'CrOSProduct                   :agent.(1)product.(1)comments.entry.product.(1)name="CrOS"^'
    extract:
    - 'DeviceClass                         :   2015 :"Desktop"'
    - 'DeviceBrand                         :   2015 :"Google"'
    - 'DeviceName                          :   2015 :"Chromebook"'
    - 'DeviceCpu                           :   2015 :LookUp[CPUArchitectures;@CrOSProduct.(1)version]'
    - 'OperatingSystemClass                :   2015 :"Desktop"'
    - 'OperatingSystemName                 :   2015 :"Chrome OS"'
    - 'OperatingSystemVersion              :   2015 :@CrOSProduct.(2)version'

- matcher:
    extract:
    - 'DeviceClass                         :   2014 :"Desktop"'
    - 'DeviceBrand                         :   2014 :"Google"'
    - 'DeviceName                          :   2014 :"Chromebook"'
    - 'OperatingSystemClass                :   2014 :"Desktop"'
    - 'OperatingSystemName                 :   2014 :"Chrome OS"'
    - 'OperatingSystemVersion              :   2014 :agent.(1)product.(1)comments.entry.product.(1)name="CrOS"^.(1)version'


- matcher:
    require:
    - 'agent.(1)product.(1)name~"Android"'
    extract:
    - 'DeviceClass                         :      1 :"Mobile"'
    - 'OperatingSystemClass                :      1 :"Mobile"'
    - 'OperatingSystemName                 :      1 :"Android"'
    - 'OperatingSystemVersion              :      1 :"??"'

- matcher:
    require:
    - 'agent.(1)product.(1)name="Android-Mail"'
    extract:
    - 'OperatingSystemClass                :    100 :"Mobile"'
    - 'OperatingSystemName                 :    100 :"Android"'
    - 'OperatingSystemVersion              :    100 :"??"'
    - 'OperatingSystemNameVersion          :    100 :"Android ??"'
    - 'AgentClass                          :    100 :"Special"'
    - 'AgentName                           :    100 :"Android-Mail"'
    - 'AgentVersion                        :    100 :agent.(1)product.(1)version'

# Android-Mail --> This is the GMail app on Android
- matcher:
    require:
    - 'agent.(1)product.(1)name[-2]="Android-SAMSUNG"'
    extract:
    - 'DeviceClass                         :      1 :"Mobile"'
    - 'DeviceBrand                         :      1 :"Samsung"'
    - 'DeviceName                          :      1 :agent.(1)product.(1)name[3-]'

# AndroidDownloadManager

#Stock android browser
#http://stackoverflow.com/questions/14403766/how-to-detect-the-stock-android-browser
# The stock Android browser never went above 534, and Chrome is 537 or higher.

# My analysis:
# There is no browser on Android that is Safari.
# So if we conclude that it must be Safari then it really is the stock android browser.

- matcher:
    require:
    - 'agent.product.(1)name="Mobile Safari"'
    - 'agent.(1)product.comments.entry.product.(1)name[1]="Android"'
    extract:
    - 'AgentClass                          :     56 :"Browser"'
    - 'AgentName                           :     56 :"Stock Android Browser"'
    - 'AgentVersion                        :     56 :agent.product.(1)name="Version"^.version'

- matcher:
    require:
    - 'agent.product.(1)name="Safari"'
    - 'agent.(1)product.comments.entry.product.(1)name[1]="Android"'
    extract:
    - 'AgentClass                          :     56 :"Browser"'
    - 'AgentName                           :     56 :"Stock Android Browser"'
    - 'AgentVersion                        :     56 :agent.product.(1)name="Version"^.version'

- matcher:
    extract:
    - 'AgentClass                          :     10 :"Browser"'
    - 'AgentName                           :     10 :"Stock Android Browser"'
    - 'AgentVersion                        :     10 :agent.product.(1)name[1]="Android"^.version'


# Tablet classified as phone


- matcher:
    require:
    - 'agent.(1)product.(1)comments.entry.(1)product.(1)name[1]="Phone"'
    extract:
    - 'DeviceClass                         :   1001 :"Phone"'

- matcher:
    require:
    - 'agent.(1)product.(1)comments.entry.(1)product.(1)name[2]="Phone"'
    extract:
    - 'DeviceClass                         :   1001 :"Phone"'

- matcher:
    require:
    - 'agent.(1)product.(1)comments.entry.(1)product.(1)name[3]="Phone"'
    extract:
    - 'DeviceClass                         :   1001 :"Phone"'

- matcher:
    require:
    - 'agent.(1)product.(1)comments.entry.(1)product.(1)name[1]="Tablet"'
    extract:
    - 'DeviceClass                         :   1001 :"Tablet"'

- matcher:
    require:
    - 'agent.(1)product.(1)comments.entry.(1)product.(1)name[2]="Tablet"'
    extract:
    - 'DeviceClass                         :   1001 :"Tablet"'

- matcher:
    require:
    - 'agent.(1)product.(1)comments.entry.(1)product.(1)name[3]="Tablet"'
    extract:
    - 'DeviceClass                         :   1001 :"Tablet"'


# Tablet classified as phone

